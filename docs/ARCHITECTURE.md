# Архитектура системы ТОТ MVP

## Обзор архитектуры

Система "ТОТ – Твоя Точка Опоры" построена на основе микросервисной архитектуры с возможностью эволюции из монолита в микросервисы. Это обеспечивает гибкость разработки и масштабируемость системы.

## Принципы архитектуры

### 1. Domain-Driven Design (DDD)
- Разделение системы на домены по бизнес-логике
- Четкие границы между сервисами
- Общий язык между разработчиками и бизнесом

### 2. Микросервисная архитектура
- Независимые сервисы с собственными базами данных
- API Gateway для маршрутизации запросов
- Event-driven коммуникация между сервисами

### 3. Безопасность
- JWT токены для аутентификации
- Роли и права доступа (RBAC)
- Шифрование чувствительных данных
- Аудит всех действий пользователей

### 4. Масштабируемость
- Горизонтальное масштабирование сервисов
- Кэширование с Redis
- Балансировка нагрузки
- Мониторинг производительности

## Компоненты системы

### Backend Сервисы

#### 1. API Gateway (Порт: 8000)
**Назначение**: Единая точка входа для всех клиентских запросов

**Функции**:
- Маршрутизация запросов к микросервисам
- Аутентификация и авторизация
- Rate limiting
- Логирование запросов
- CORS настройки

**Технологии**: FastAPI, Python

#### 2. User Service (Порт: 8001)
**Назначение**: Управление пользователями и аутентификация

**Функции**:
- Регистрация и авторизация пользователей
- Управление профилями
- Роли и права доступа
- JWT токены

**Модели данных**:
```sql
users (
  id, email, phone, password_hash, first_name, last_name,
  role, is_active, is_verified, specialization,
  license_number, experience_years, clinic_name,
  clinic_address, clinic_license, created_at, updated_at
)
```

#### 3. Booking Service (Порт: 8003)
**Назначение**: Управление заказами вызовов врачей

**Функции**:
- Создание и управление заказами
- Назначение врачей
- Отслеживание статуса
- История заказов

**Модели данных**:
```sql
bookings (
  id, patient_id, doctor_id, clinic_id, call_type,
  symptoms, address, latitude, longitude, status,
  priority, scheduled_time, created_at, updated_at,
  assigned_at, started_at, completed_at, cancelled_at,
  notes, estimated_duration, actual_duration,
  estimated_price, final_price, is_emergency, emergency_type
)

booking_messages (
  id, booking_id, sender_id, sender_role, message_type,
  content, created_at
)

booking_status_updates (
  id, booking_id, old_status, new_status, updated_by,
  reason, created_at
)
```

#### 4. Geo Service (Порт: 8004)
**Назначение**: Геолокация и поиск врачей

**Функции**:
- Отслеживание местоположения
- Поиск врачей поблизости
- Геокодирование адресов
- Расчет маршрутов

**Модели данных**:
```sql
locations (
  id, user_id, user_type, latitude, longitude,
  address, accuracy, is_active, created_at, updated_at
)

doctor_availability (
  id, doctor_id, is_available, current_location_id,
  specialization, rating, experience_years,
  created_at, updated_at
)

location_history (
  id, user_id, latitude, longitude, address,
  accuracy, recorded_at
)
```

#### 5. Payment Service (Порт: 8005)
**Назначение**: Обработка платежей

**Функции**:
- Интеграция с платежными системами
- Создание и обработка платежей
- Возвраты и комиссии
- Финансовая отчетность

#### 6. Notification Service (Порт: 8006)
**Назначение**: Отправка уведомлений

**Функции**:
- Push уведомления
- SMS сообщения
- Email уведомления
- Напоминания

#### 7. Chat Service (Порт: 8007)
**Назначение**: Чат между пациентами и врачами

**Функции**:
- Текстовые сообщения
- Голосовые и видеозвонки
- Файловый обмен
- WebSocket соединения

#### 8. Rating Service (Порт: 8008)
**Назначение**: Рейтинги и отзывы

**Функции**:
- Оценка врачей
- Отзывы пациентов
- Расчет рейтингов
- Модерация отзывов

#### 9. Event Service (Порт: 8009)
**Назначение**: Афиша мероприятий

**Функции**:
- Создание мероприятий
- Регистрация участников
- Напоминания
- Отчеты

#### 10. Emergency Service (Порт: 8010)
**Назначение**: Экстренные вызовы

**Функции**:
- Обработка экстренных вызовов
- Приоритизация
- Уведомления экстренных служб
- Логирование инцидентов

#### 11. Security Service (Порт: 8011)
**Назначение**: Безопасность и аудит

**Функции**:
- Логирование действий
- Обнаружение подозрительной активности
- Управление черными списками
- Аудит безопасности

### Frontend Приложения

#### 1. Patient App (React Native)
**Назначение**: Мобильное приложение для пациентов

**Основные экраны**:
- Авторизация и регистрация
- Главная страница с быстрыми действиями
- Поиск и выбор врача
- Создание заказа
- Отслеживание врача на карте
- Чат с врачом
- История вызовов
- Профиль пользователя

**Технологии**: React Native, Expo, TypeScript

#### 2. Doctor App (React Native)
**Назначение**: Мобильное приложение для врачей

**Основные экраны**:
- Авторизация и верификация
- Получение вызовов
- Карта с маршрутами
- Чат с пациентами
- Завершение вызовов
- Аналитика и заработок
- Профиль врача

#### 3. Clinic Web (React)
**Назначение**: Web-интерфейс для клиник

**Основные функции**:
- Управление услугами
- Статистика вызовов
- Управление врачами
- Финансовая отчетность
- Настройки клиники

#### 4. Admin Panel (React)
**Назначение**: Административная панель

**Основные функции**:
- Модерация врачей и документов
- Управление пользователями
- Мониторинг системы
- Аналитика и отчеты
- Настройки системы

## База данных

### PostgreSQL
**Назначение**: Основная реляционная база данных

**Схемы**:
- `public` - общие таблицы
- `auth` - аутентификация
- `booking` - заказы
- `geo` - геолокация
- `payment` - платежи
- `notification` - уведомления
- `chat` - чаты
- `rating` - рейтинги
- `event` - мероприятия
- `emergency` - экстренные вызовы
- `security` - безопасность

### Redis
**Назначение**: Кэширование и очереди

**Использование**:
- Кэш сессий
- Очереди задач
- Временные данные
- Pub/Sub для уведомлений

## Интеграции

### Внешние API

#### 1. Геолокация
- **Yandex Maps API**: Геокодирование и карты
- **2GIS API**: Альтернативный провайдер карт
- **OpenStreetMap**: Бесплатные карты

#### 2. Платежи

- **ЮKassa**: Основная платежная система
- **СБП**
#### 3. Уведомления
- **Firebase Cloud Messaging**: Push уведомления
- **Twilio**: SMS и голосовые звонки
- **SendGrid**: Email уведомления

#### 4. Видеозвонки
- **Agora**: Видеозвонки
- **Twilio Video**: Альтернативное решение
- **WebRTC**: Прямые соединения

## Безопасность

### Аутентификация и авторизация
- **JWT токены** с коротким временем жизни
- **Refresh токены** для обновления сессий
- **Роли и права доступа** (RBAC)
- **OAuth2** для внешних провайдеров

### Защита данных
- **HTTPS** для всех соединений
- **Шифрование** чувствительных данных
- **Хеширование** паролей (bcrypt)
- **Валидация** всех входных данных

### Аудит и мониторинг
- **Логирование** всех действий
- **Мониторинг** подозрительной активности
- **Алерты** при нарушениях безопасности
- **Резервное копирование** данных

## Масштабирование

### Горизонтальное масштабирование
- **Docker контейнеры** для каждого сервиса
- **Kubernetes** для оркестрации (в будущем)
- **Балансировка нагрузки** через Nginx
- **Автоскейлинг** на основе метрик

### Вертикальное масштабирование
- **Оптимизация** запросов к базе данных
- **Кэширование** часто используемых данных
- **Индексирование** базы данных
- **CDN** для статических файлов

## Мониторинг

### Метрики
- **Prometheus**: Сбор метрик
- **Grafana**: Визуализация дашбордов
- **AlertManager**: Уведомления о проблемах

### Логирование
- **ELK Stack**: Elasticsearch, Logstash, Kibana
- **Structured logging**: JSON формат логов
- **Log aggregation**: Централизованный сбор логов

### Трейсинг
- **Jaeger**: Распределенная трассировка
- **OpenTelemetry**: Стандарт для трейсинга
- **Performance monitoring**: Мониторинг производительности

## CI/CD

### Pipeline
1. **Code Review**: Проверка кода
2. **Automated Testing**: Unit и интеграционные тесты
3. **Security Scanning**: Проверка безопасности
4. **Build**: Сборка Docker образов
5. **Deploy**: Развертывание в тестовую среду
6. **Integration Testing**: Тестирование интеграции
7. **Production Deploy**: Развертывание в продакшн

### Инструменты
- **GitHub Actions**: CI/CD pipeline
- **Docker**: Контейнеризация
- **Helm**: Управление Kubernetes (в будущем)
- **ArgoCD**: GitOps для развертывания

## Резервное копирование

### Стратегия
- **Ежедневные** полные резервные копии
- **Почасовая** инкрементальная синхронизация
- **Географическое** распределение копий
- **Тестирование** восстановления

### Хранение
- **Локальное** хранилище для быстрого восстановления
- **Облачное** хранилище для долгосрочного хранения
- **Шифрование** резервных копий
- **Версионирование** резервных копий

## Производительность

### Оптимизация
- **Кэширование** на всех уровнях
- **CDN** для статических ресурсов
- **Сжатие** данных
- **Оптимизация** изображений

### Метрики
- **Response Time**: < 200ms для API
- **Throughput**: > 1000 RPS
- **Availability**: 99.9%
- **Error Rate**: < 0.1%

## Планы развития

### Краткосрочные (3-6 месяцев)
- Завершение MVP функциональности
- Тестирование в пилотном регионе
- Оптимизация производительности
- Улучшение безопасности

### Среднесрочные (6-12 месяцев)
- Масштабирование на новые города
- Интеграция с медицинскими системами
- Мобильные приложения для iOS/Android
- Аналитика и машинное обучение

### Долгосрочные (1-2 года)
- Международная экспансия
- Интеграция с IoT устройствами
- AI для диагностики
- Blockchain для медицинских записей

## Заключение

Архитектура системы ТОТ MVP обеспечивает:
- **Масштабируемость** для роста пользователей
- **Надежность** для критически важных операций
- **Безопасность** для защиты медицинских данных
- **Гибкость** для быстрого развития
- **Производительность** для отзывчивого интерфейса

Система готова к развертыванию и дальнейшему развитию согласно бизнес-требованиям. 